- alias         : general_picnic_delivery_known
  id            : a7bc83ae-92cd-40a5-8869-d73643c9513b
  mode          : queued
  description   : Send a notification when the short window of the picnic delivery is known

  trigger:
    - platform  : state
      entity_id:
        - sensor.picnic_last_order_eta_start
        - sensor.picnic_last_order_eta_end
    - platform  : time
      at        : '18:59:00'
    - platform: template  # Trigger 10 minutes before eta start time.
      value_template: >-
        {% if states('sensor.picnic_last_order_slot_start') != "unavailable" %}
          {{ 600 > (as_timestamp(states('sensor.picnic_last_order_eta_start')) - as_timestamp(states('sensor.date') + " " + states('sensor.time'))) > 0}}
        {% endif %}

  variables:
    days_left: "{{ as_timestamp(states('sensor.picnic_last_order_eta_start')) | timestamp_custom('%d') | int - as_timestamp(now()) | timestamp_custom('%d') | int }}"
    day_name: >-
        {% if days_left == 0 %} vandaag
        {% elif days_left == 1 %} morgen
        {% endif %}

  condition:
    - "{{ days_left < 2 }}"
    - "{{ as_timestamp(states('sensor.picnic_last_order_eta_start')) > as_timestamp(now()) }}"
  
  action:
    - service   : tts.cloud_say
      entity_id : media_player.smart_speaker
      data:
        message : >
          Picnic bezorgt {{ day_name }}, tussen {{ as_timestamp(states('sensor.picnic_last_order_eta_start')) | timestamp_custom('%H:%M') }} en {{ as_timestamp(states('sensor.picnic_last_order_eta_end')) | timestamp_custom('%H:%M') }}!
        language: 'nl-NL'

    - service   : notify.all
      data:
        title   : Picnic komt eraan!
        message : >
          Picnic bezorgt {{ day_name }}, tussen {{ as_timestamp(states('sensor.picnic_last_order_eta_start')) | timestamp_custom('%H:%M') }} en {{ as_timestamp(states('sensor.picnic_last_order_eta_end')) | timestamp_custom('%H:%M') }}!
        data:
          tag         : "picnic_alert"  # Replace notification with the same tag
          icon_url    : "https://picnic.app/nl/wp-content/uploads/sites/18/2020/11/logo.png"
          clickAction : "app://com.picnic.android"
          timeout     : 1800 # How many seconds the notification should be received by the device
